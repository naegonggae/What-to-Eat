<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: header}"/>
<style>
  /* í¼ì„ í™”ë©´ ê°€ìš´ë°ë¡œ ì •ë ¬í•˜ê³  ì—¬ë°±ì„ ì¶”ê°€í•©ë‹ˆë‹¤. */
  .centered-form {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
    background-color: #f0f0f0; /* ë°ì€ íšŒìƒ‰ ë°°ê²½ìƒ‰ */
  }

  /* í¼ ìš”ì†Œ ê°„ì˜ ì—¬ë°±ì„ ì¡°ì •í•©ë‹ˆë‹¤. */
  .form-group {
    margin-bottom: 20px;
  }

  /* ì…ë ¥ì°½ ë°‘ì— ë°‘ì¤„ì„ ì¶”ê°€í•©ë‹ˆë‹¤. */
  .form-control.with-underline {
    border-bottom: 1px solid #000;
  }
</style>
</head>
<body style="background-color: #f0f0f0;">
<nav class="navbar bg-dark navbar-expand-lg">
  <div class="container-fluid">
    <a class="navbar-brand" style="color: white; font-weight: bold;">ğŸ° ë­ë¨¹ Home</a>
  </div>
</nav>
<div class="container"> <!-- í¼ì„ ê°ì‹¸ëŠ” ì»¨í…Œì´ë„ˆì— centered-form í´ë˜ìŠ¤ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤. -->

  <div class="centered-form">
    <form role="form" action="/view/auth/login" th:object="${loginRequest}" method="post">
      <div class="form-group">
        <h1 class="text-center my-4">Sign in</h1>
        <label th:for="username">ì•„ì´ë””</label>
        <input type="text" th:field="*{username}" class="form-control with-underline" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
               th:class="${#fields.hasErrors('username')}? 'form-control fieldError with-underline' : 'form-control with-underline'">
        <p th:if="${#fields.hasErrors('username')}" th:errors="*{username}" class="with-underline">Incorrect date</p>
      </div>
      <div class="form-group">
        <label th:for="password">ë¹„ë°€ë²ˆí˜¸</label>
        <input type="text" th:field="*{password}" class="form-control with-underline" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
      </div>
      <button type="submit" class="btn btn-primary form-control with-underline">ë¡œê·¸ì¸</button>
    </form>
    <div class="my-4">
      <a href="/">ë¹„ë°€ë²ˆí˜¸ë¥¼ ìŠìœ¼ì…¨ë‚˜ìš”?</a>
    </div>
    <p>ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <a href="/view/auth/join">ê°€ì…í•˜ê¸°</a></p> <!-- ë²„íŠ¼ì˜ ë§í¬ ì†ì„±ì„ ìˆ˜ì •í•©ë‹ˆë‹¤. -->
  </div>
</div> <!-- /container -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script th:inline="javascript">
  async function login() {

    let username = $("#username").val();
    let password = $("#password").val();

    console.log(username, password)
    await axios.post("/api/v1/auth/login", {
          "username": username,
          "password": password,
        }
        // {withCredentials: true}
    ).then(res => {
      let config = {
        headers: {
          "Authorization": "Bearer " + res.data.result.accessToken
        }
      }
      if (res.data.resultCode == 'SUCCESS') {
        console.log("ì„±ê³µì§„ì…")
        const accessToken  = res.data.result.accessToken;
        axios.defaults.headers.common['Authorization'] = `Bearer ${accessToken}`;

        // window.localStorage.setItem("accessToken", res.data.result.accessToken);
        document.location.href = "/home";

      } else {
        // localStorage.clear()
        console.log("ì•„ë¬´ê²ƒë„ í• ê²Œ ì—†ì–´ì„œ ê·¸ëƒ¥ ì¢…ë£Œ")
        alert('ì•„ì´ë”” í˜¹ì€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì˜ëª» ì…ë ¥í•˜ì…¨ìŠµë‹ˆë‹¤.');
      }
    }).catch(err => {
      let errMsg = err.response.data.result.message;

      if (errMsg === 'ì¡´ì¬í•˜ì§€ ì•ŠëŠ” íšŒì›ì…ë‹ˆë‹¤.' || errMsg === 'Not founded'){
        console.log(errMsg)
        alert('ì•„ì´ë”” í˜¹ì€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì˜ëª» ì…ë ¥í•˜ì…¨ìŠµë‹ˆë‹¤.');
        let username = document.getElementById('username');
        let password = document.getElementById('password');
        username.value = null;
        password.value = null;
        // localStorage.clear()
      }
    });

    // const accessToken = window.localStorage.getItem("accessToken");
    if (accessToken != null) {
      axios.defaults.headers.common['Authorization'] = `Bearer ${accessToken}`;
      document.location.href = "/home";
      return true;
    }
  }
  // /** í—¤ë”ì— í† í°ê°’ì´ ì—†ìœ¼ë©´ ë‹´ì•„ì¤Œ */
  // axios.interceptors.request.use(function (config) {
  //   console.log("ì¸í„°ì…‰í„° ì‹œì‘")
  //   const accessToken = localStorage.getItem('accessToken');
  //
  //   if (accessToken) {
  //     config.headers.Authorization = `Bearer ${accessToken}`;
  //   }
  //   return config;
  // })

</script>
</body>
</html>
